<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¦é—¨å¸‚é‡ç‚¹è´­ç‰©ä¸­å¿ƒåœ°å›¾ (2025å¹´)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Leaflet & Plugins CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --bg-color: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --border-radius: 12px;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* é€šç”¨é¢æ¿æ ·å¼ */
        .panel-card {
            background: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(0,0,0,0.05);
            color: var(--text-main);
        }

        /* åœ°å›¾å³ä¸Šè§’ä¿¡æ¯æ¡† */
        .info-panel {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            line-height: 1.5;
            backdrop-filter: blur(4px);
        }
        .info-panel h4 {
            margin: 0 0 8px;
            font-weight: 700;
            color: var(--text-main);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 4px;
            display: inline-block;
        }

        /* å›¾ä¾‹æ ·å¼ */
        .legend {
            line-height: 1.6;
            font-size: 13px;
        }
        .legend i {
            width: 16px;
            height: 16px;
            float: left;
            margin-right: 8px;
            border-radius: 4px;
            opacity: 0.9;
        }

        /* ç­‰çº§æ ‡ç­¾ */
        .grade-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 11px;
            margin-right: 5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .grade-Aplus { background-color: #dc2626; }
        .grade-A { background-color: #ea580c; }
        .grade-Aminus { background-color: #f59e0b; }
        .grade-B { background-color: #3b82f6; }
        .grade-C { background-color: #06b6d4; }
        .grade-none { background-color: #9ca3af; }

        /* èŒƒå›´æ§åˆ¶é¢æ¿ */
        #radius-control {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: calc(100vh - 40px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease;
        }
        
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: move;
        }
        .control-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            border-radius: 4px;
        }
        .close-btn:hover {
            background-color: #f3f4f6;
            color: var(--danger-color);
        }

        .input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        /* è®°å½•åˆ—è¡¨åŒºåŸŸ */
        #records-section {
            margin-top: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-top: 1px solid #e5e7eb;
            padding-top: 15px;
        }
        .tab-container {
            display: flex;
            background: #f3f4f6;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .tab-btn {
            flex: 1;
            border: none;
            background: none;
            padding: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-light);
            border-radius: 6px;
            cursor: pointer;
        }
        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .records-list {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 4px;
        }
        .record-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-left-width: 4px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .record-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .btn-xs {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn-danger { background: #fee2e2; color: #b91c1c; }
        .btn-danger:hover { background: #fecaca; }

        /* POI æœç´¢å¼¹çª— */
        #poi-search-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 340px;
            z-index: 2000;
            padding: 24px;
            flex-direction: column;
        }
        #poi-results {
            margin-top: 12px;
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #e5e7eb;
        }
        .poi-batch-header {
            background: #e5e7eb;
            color: var(--text-main);
            font-size: 12px;
            font-weight: 700;
            padding: 6px 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .poi-item {
            padding: 10px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }
        .poi-item span:last-child { color: var(--text-light); font-size: 12px; }

        /* åœ°å›¾ä¸Šçš„æ ‡ç­¾æ ·å¼ */
        .map-label-base {
            background-color: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            padding: 2px 6px;
            white-space: nowrap;
            color: var(--text-main);
        }
        
        /* å•†åœºæ ‡ç­¾ï¼šæ›´å¤§æ›´é†’ç›® */
        .mall-label {
            font-size: 12px;
            font-weight: 700;
            z-index: 500;
        }
        
        /* POIæ ‡ç­¾ï¼šç¨å°ä¸€ç‚¹ */
        .poi-label {
            font-size: 11px;
            font-weight: 500;
            color: #059669;
            z-index: 400;
        }

        .leaflet-tooltip-left.map-label-base::before { border-left-color: rgba(255, 255, 255, 0.95); }
        .leaflet-tooltip-right.map-label-base::before { border-right-color: rgba(255, 255, 255, 0.95); }
        .leaflet-tooltip-top.map-label-base::before { border-top-color: rgba(255, 255, 255, 0.95); }
        .leaflet-tooltip-bottom.map-label-base::before { border-bottom-color: rgba(255, 255, 255, 0.95); }

        .marker-pin {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .popup-search-btn {
            background: var(--text-main);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }
        .popup-search-btn:hover { background: black; }

        .leaflet-control-measure {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 10px !important;
        }
        .leaflet-control-measure .leaflet-control-measure-toggle {
            background-color: #f3f4f6 !important;
            width: 100% !important;
            height: 40px !important;
            background-image: none !important;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px !important;
            color: var(--text-main);
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
        }
        .leaflet-control-measure .leaflet-control-measure-toggle::after {
            content: "ğŸ“ ç‚¹å‡»å¯ç”¨æµ‹é‡å·¥å…·";
            margin-left: 5px;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body>

    <div id="map"></div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="radius-control" class="panel-card">
        <div class="control-header">
            <h3 class="control-title">ğŸ› ï¸ èŒƒå›´æŸ¥è¯¢ä¸åˆ†æ</h3>
            <button id="toggle-control" class="close-btn" title="éšè—é¢æ¿">&times;</button>
        </div>
        
        <!-- æµ‹é‡å·¥å…·è‡ªåŠ¨æ’å…¥æ­¤å¤„ -->

        <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; color: var(--text-light); display: block; margin-bottom: 5px;">å»ºç«‹ç¼“å†²åŒº (åˆ†æå‘¨è¾¹å•†ä¸šå¯†åº¦)</label>
            <div class="input-group">
                <input type="number" id="radius-input" value="1.5" min="0.1" step="0.1" placeholder="åŠå¾„">
                <select id="radius-unit" style="width: 90px;">
                    <option value="kilometers">å…¬é‡Œ</option>
                    <option value="meters">ç±³</option>
                </select>
            </div>
            <button id="radius-button" class="btn-primary">ğŸ¯ ç‚¹å‡»åœ°å›¾é€‰ç‚¹åˆ†æ</button>
        </div>
        
        <div id="records-section">
            <div class="tab-container">
                <button class="tab-btn active" id="current-tab">å½“å‰ç»“æœ</button>
                <button class="tab-btn" id="history-tab">å†å²è®°å½•</button>
            </div>
            
            <div class="records-list" id="records-list">
                <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 13px;">
                    åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä»»æ„ä½ç½®<br>æŸ¥çœ‹èŒƒå›´å†…åŒ…å«çš„å•†åœº
                </div>
            </div>
            
            <div style="margin-top: 10px; display: flex; gap: 5px; flex-direction: column;">
                <button class="btn-primary" id="clear-all-btn" style="background: var(--text-light); display: none; font-size: 12px;">æ¸…ç©ºèŒƒå›´åˆ†æ</button>
                <button class="btn-primary" id="clear-poi-btn" style="background: var(--success-color); display: none; font-size: 12px;">ğŸ§¹ æ¸…é™¤æ‰€æœ‰å‘¨è¾¹æœç´¢ç»“æœ (åœ°å›¾+åˆ—è¡¨)</button>
            </div>
        </div>
    </div>

    <!-- POI æœç´¢æ¨¡æ€æ¡† -->
    <div id="poi-search-modal" class="panel-card">
        <div class="control-header">
            <span id="poi-modal-title" class="control-title">å‘¨è¾¹æœç´¢</span>
            <button id="poi-modal-close-btn" class="close-btn">&times;</button>
        </div>
        <div class="input-group">
            <input type="text" id="poi-keyword-input" placeholder="æœç´¢å…³é”®è¯ (å¦‚: å’–å•¡, åœè½¦åœº)..." style="width: 100%;">
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="poi-search-btn" class="btn-primary">ğŸ” å åŠ æœç´¢</button>
        </div>
        <div id="poi-results"></div>
    </div>
    
    <!-- æ¢å¤æ˜¾ç¤ºæŒ‰é’® -->
    <button id="show-control-btn" class="panel-card" style="position: absolute; top: 10px; right: 10px; z-index: 999; padding: 10px; display: none; border: none; cursor: pointer; font-weight: 600;">
        ğŸ› ï¸ æ‰“å¼€å·¥å…·ç®±
    </button>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.chinesetmsproviders@1.0.22/src/leaflet.ChineseTmsProviders.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.cn.js"></script>
    
    <script>
        var map = L.map("map", {
            zoomControl: false
        }).setView([24.49, 118.12], 12);
        
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer.chinaProvider('GaoDe.Normal.Map', {
            maxZoom: 18,
            minZoom: 10,
            attribution: 'é«˜å¾·åœ°å›¾'
        }).addTo(map);

        const districtStyles = {
            "æµ·æ²§åŒº": { color: "#e41a1c", name: "æµ·æ²§åŒº" },
            "é›†ç¾åŒº": { color: "#377eb8", name: "é›†ç¾åŒº" },
            "åŒå®‰åŒº": { color: "#4daf4a", name: "åŒå®‰åŒº" },
            "æ€æ˜åŒº": { color: "#ff7f00", name: "æ€æ˜åŒº" },
            "ç¿”å®‰åŒº": { color: "#ffd700", name: "ç¿”å®‰åŒº" },
            "æ¹–é‡ŒåŒº": { color: "#ffff33", name: "æ¹–é‡ŒåŒº" }
        };

        function createColoredIcon(color) {
            const svgIcon = window.btoa(`
                <svg width="25" height="41" viewBox="0 0 25 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 0C5.596 0 0 5.596 0 12.5C0 19.404 5.596 25 12.5 25C19.404 25 25 19.404 25 12.5C25 5.596 19.404 0 12.5 0Z" fill="${color}"/>
                    <path d="M12.5 35.5C18.299 35.5 23 30.799 23 25H2C2 30.799 6.701 35.5 12.5 35.5Z" fill="${color}"/>
                    <circle cx="12.5" cy="12.5" r="6" fill="#ffffff"/>
                </svg>
            `);
            return L.icon({
                iconUrl: `data:image/svg+xml;base64,${svgIcon}`,
                shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        for (const key in districtStyles) {
            districtStyles[key].icon = createColoredIcon(districtStyles[key].color);
        }

        // å®Œæ•´å•†åœºæ•°æ®
        var xiamen_malls = [
            {name: "å¦é—¨ä¸‡è±¡åŸ", lat: 24.472250, lng: 118.111010, address: "æ¹–æ»¨ä¸œè·¯99å·(æ¹–æ»¨ä¸œè·¯åœ°é“ç«™6å·å£æ­¥è¡Œ60ç±³)", desc: "", grade: "A+", district: "æ€æ˜åŒº"},
            {name: "ä¸­ååŸ", lat: 24.452752, lng: 118.082665, address: "æ€æ˜å—è·¯195å·", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "å®é¾™ä¸€åŸ", lat: 24.485801, lng: 118.172970, address: "é‡‘å±±è·¯1å·(å²­å…œåœ°é“ç«™1Aå£æ­¥è¡Œ50ç±³)", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "ç£åŸºåå“ä¸­å¿ƒ", lat: 24.481554, lng: 118.120682, address: "è²èŠ±è·¯å£åœ°é“ç«™1Aå£æ­¥è¡Œ160ç±³", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "ç£åŸºè²èŠ±é‡Œ", lat: 24.484334, lng: 118.127433, address: "è²èŠ±åŒ—è·¯ä¸å˜‰è²é‡Œäº¤å‰å£ä¸œå—100ç±³", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "ä¸–èŒ‚æµ·å³¡å¤§å¦", lat: 24.435581, lng: 118.088740, address: "æ¼”æ­¦è¥¿è·¯180-188å·(å¦å¤§åŒ»é™¢æ—)", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨ç¦¹æ‚¦æ±‡", lat: 24.467780, lng: 118.113791, address: "å¦ç¦¾è·¯882-888å·", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "ç½—å®¾æ£®å¹¿åœº", lat: 24.468932, lng: 118.112681, address: "å¦ç¦¾è·¯899å·", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "å¤©è™¹è´­ç‰©ä¸­å¿ƒ(å¦é—¨ç­¼ç­œåº—)", lat: 24.491751, lng: 118.113856, address: "è²å²³è·¯221å·", desc: "", grade: "A-", district: "æ€æ˜åŒº"},
            {name: "å¤©è™¹å•†åœº(æ±‡è…¾åº—)", lat: 24.491451, lng: 118.127272, address: "å˜‰ç¦¾è·¯323å·", desc: "", grade: "A-", district: "æ€æ˜åŒº"},
            {name: "æ±‡æˆå•†ä¸šä¸­å¿ƒ", lat: 24.466493, lng: 118.104231, address: "æ¹–æ»¨ä¸­è·¯6å·(æ–‡ç¶åœ°é“ç«™2å·å£æ—)", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "ç¦æ˜Ÿå•†ä¸šä¸­å¿ƒ", lat: 24.491876, lng: 118.133532, address: "å•å²­è·¯120å·(æ±Ÿå¤´åœ°é“ç«™2Aå£æ­¥è¡Œ390ç±³)", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "ç‘æ™¯å•†ä¸šå¹¿åœº(è²å‰ä¸œè·¯)", lat: 24.475070, lng: 118.159704, address: "è²å‰ä¸œè·¯288å·", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "è€è™åŸæ¬¢ä¹è´­ç‰©ä¸­å¿ƒ", lat: 24.453026, lng: 118.080980, address: "æ€æ˜å—è·¯ä¸­æ®µæ°‘ç››å•†å¦åœ°ä¸‹ä¸€å±‚", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "åŠ å·å•†ä¸šå¹¿åœº", lat: 24.477278, lng: 118.158174, address: "è²å‰ä¸œè·¯123å·", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æ‚¦äº«(ä¸­å¿ƒåº—)", lat: 24.494703, lng: 118.112998, address: "æ¾å²³è·¯8å·å»ºå‘Â·æ‚¦äº«ä¸­å¿ƒF2å±‚", desc: "", grade: "B", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æ˜Ÿæ²³COCO Park", lat: 24.474718, lng: 118.189093, address: "å±•é¸¿è·¯81-89å·", desc: "", grade: "A-", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æµ·å³¡ä¸–èŒ‚å¹¿åœº", lat: 24.435581, lng: 118.088740, address: "æ¼”æ­¦è¥¿è·¯180-188å·", desc: "", grade: "A", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨èˆªç©º", lat: 24.468098, lng: 118.167658, address: "å‰åŸ”å…­é‡Œä¸å‰åŸ”å—è·¯äº¤å‰å£è¥¿åŒ—60ç±³", desc: "", grade: "C", district: "æ€æ˜åŒº"},
            {name: "è½¯ä»¶å›­ç”Ÿæ´»å¹¿åœº", lat: 24.484360, lng: 118.176763, address: "å²­å…œè¥¿è·¯623å·(å²­å…œåœ°é“ç«™3å·å£æ­¥è¡Œ290ç±³)", desc: "", grade: "C", district: "æ€æ˜åŒº"},
            {name: "ä¸œæ–¹æ—¶ä»£è´­ç‰©å¹¿åœº", lat: 24.461486, lng: 118.079863, address: "æ¹–æ»¨è¥¿è·¯12å·", desc: "", grade: "C", district: "æ€æ˜åŒº"},
            {name: "æ€æ˜æ¬¢ä¹é¢‚å•†åœº", lat: 24.486296, lng: 118.095641, address: "ä¸ƒæ˜Ÿè¥¿è·¯3å·", desc: "", grade: "C", district: "æ€æ˜åŒº"},
            {name: "æ˜å‘å•†ä¸šå¹¿åœº", lat: 24.478639, lng: 118.123245, address: "è²å‰è¥¿è·¯ä¸å˜‰ç¦¾è·¯äº¤æ±‡å¤„ä¸œåŒ—è§’", desc: "", grade: "C", district: "æ€æ˜åŒº"},
            {name: "ç¦¾ç¥¥é‘«å¤©åœ°(è£…ä¿®ä¸­)", lat: 24.468854, lng: 118.105113, address: "ååŸ­æºªè·¯ä¸é‡‘æ¦œè¥¿å››è·¯äº¤å‰å£è¥¿180ç±³", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "SMåŸå¸‚å¹¿åœº(å¦é—¨æ¹–é‡Œåº—)", lat: 24.500849, lng: 118.126101, address: "å˜‰ç¦¾è·¯468å·", desc: "", grade: "A+", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æ¹–é‡Œä¸‡è¾¾å¹¿åœº", lat: 24.504657, lng: 118.177299, address: "ä»™å²³è·¯4666å·1Få±‚105å·å•†é“º", desc: "", grade: "A", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨è”¡å¡˜çˆ±ç´æµ·è´­ç‰©ä¸­å¿ƒ", lat: 24.485380, lng: 118.156300, address: "å•å²­è·¯1068å·(è”¡å¡˜åœ°é“ç«™4Bå£æ­¥è¡Œ400ç±³)", desc: "", grade: "B", district: "æ¹–é‡ŒåŒº"},
            {name: "å¤©è™¹è´­ç‰©ä¸­å¿ƒ(äº”ç¼˜æ¹¾åº—)", lat: 24.509873, lng: 118.160382, address: "é‡‘æ¹–è·¯516å·", desc: "", grade: "B", district: "æ¹–é‡ŒåŒº"},
            {name: "å˜‰ç¦¾æ–°å¤©åœ°", lat: 24.512903, lng: 118.119287, address: "ç«ç‚¬è·¯1å·(ç«ç‚¬å›­åœ°é“ç«™4å·å£æ—)", desc: "", grade: "C", district: "æ¹–é‡ŒåŒº"},
            {name: "æ¹¾æ‚¦åŸ", lat: 24.515630, lng: 118.161623, address: "æ—¥åœ†äºŒé‡Œ1å·", desc: "", grade: "B", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æµ·ä¸Šä¸–ç•Œè´­ç‰©ä¸­å¿ƒ", lat: 24.490000, lng: 118.076122, address: "è¿œèˆªè·¯77å·å¦é—¨æµ·ä¸Šä¸–ç•Œ405A", desc: "", grade: "A", district: "æ¹–é‡ŒåŒº"},
            {name: "å¾æ‚¦å®¶å±…(å¦é—¨æ’è¾‰å•†åŠ¡ä¸­å¿ƒåº—)", lat: 24.528930, lng: 118.157583, address: "å²­ä¸‹å—è·¯77å·å¦é—¨æ’è¾‰å•†åŠ¡ä¸­å¿ƒ", desc: "", grade: "C", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨é¹­æ¸¯", lat: 24.522193, lng: 118.109526, address: "é•¿ä¹è·¯350å·", desc: "", grade: "B", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æµ·æ²§æ‹›å•†èŠ±å›­åŸ", lat: 24.536560, lng: 117.997334, address: "æ–°æ™¯ä¸œé‡Œ200å·(åœ°é“2å·çº¿æ–°é˜³å¤§é“3å·å‡ºå£)", desc: "", grade: "B", district: "æµ·æ²§åŒº"},
            {name: "ä¸­å»ºé—½æ³°å»ºè®¾å¼€å‘æœ‰é™å…¬å¸å¦é—¨SMé©¬éŠ®æ¹¾é¡¹ç›®ç®¡ç†éƒ¨(å»ºè®¾ä¸­)", lat: 24.539346, lng: 117.956065, address: "å­šè²è·¯ä¸ä¸œå­šè¥¿è·¯äº¤å‰å£ä¸œå—çº¦160ç±³", desc: "", grade: "", district: "æµ·æ²§åŒº"},
            {name: "è¥¿é›…å›¾è´­ç‰©ä¸­å¿ƒ", lat: 24.493055, lng: 118.028228, address: "é©¬é’è·¯ä¸é’Ÿæ—è·¯äº¤æ±‡å¤„(åœ°é“é©¬é’è·¯ç«™)", desc: "", grade: "C", district: "æµ·æ²§åŒº"},
            {name: "é˜¿ç½—æµ·åŸå¸‚å¹¿åœº", lat: 24.480404, lng: 118.032116, address: "æ»¨æ¹–åŒ—äºŒè·¯70å·", desc: "", grade: "C", district: "æµ·æ²§åŒº"},
            {name: "å¦é—¨å°šæŸå¥¥ç‰¹è±æ–¯", lat: 24.621979, lng: 118.072913, address: "åå¤è·¯1å·", desc: "", grade: "B", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨å¤§æ‚¦åŸ", lat: 24.592382, lng: 118.055468, address: "è¯šæ¯…ä¸­è·¯ä¸ææ—æ¹¾è·¯äº¤å‰å£è¥¿140ç±³", desc: "", grade: "A-", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨é¾™æ¹–é›†ç¾å¤©è¡—(è£…ä¿®ä¸­)", lat: 24.585352, lng: 118.052448, address: "æé”¦è·¯è¾…è·¯ä¸æåŒ—è·¯äº¤å‰å£å—140ç±³", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨å’Œç¾å¤©åœ°", lat: 24.604974, lng: 118.051339, address: "è¥¿äº­åŒ—äºŒè·¯ä¸è¯šæ¯…å¤§è¡—äº¤å‰å£è¥¿140ç±³", desc: "", grade: "C", district: "é›†ç¾åŒº"},
            {name: "ä¸‡è¾¾å¹¿åœº(å¦é—¨ææ—åº—)", lat: 24.590956, lng: 118.013908, address: "æå‰è·¯262-101å·ä¹‹äºŒ", desc: "", grade: "B", district: "é›†ç¾åŒº"},
            {name: "iOi MALL", lat: 24.600689, lng: 118.075097, address: "æ»¨æ°´è·¯ä¸­äº”é‡Œ1å·", desc: "", grade: "B", district: "é›†ç¾åŒº"},
            {name: "ä¸‡è¾¾å¹¿åœº(å¦é—¨é›†ç¾åº—)", lat: 24.573357, lng: 118.092658, address: "é“¶æ±Ÿè·¯137å·", desc: "", grade: "A-", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨é›†ç¾ä¸–èŒ‚å¹¿åœº", lat: 24.602113, lng: 118.076472, address: "ä¾¨è‹±è¡—é“æ»¨æ°´ä¸­äºŒé‡Œ32-33å·", desc: "", grade: "B", district: "é›†ç¾åŒº"},
            {name: "å¤§æ˜å¹¿åœº", lat: 24.592825, lng: 118.052483, address: "ç«‹è¨€è·¯ä¸æœæ—­è·¯äº¤å‰å£å—140ç±³", desc: "", grade: "C", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨åŒå®‰å®é¾™å¹¿åœº", lat: 24.716671, lng: 118.165639, address: "ç¯åŸå—è·¯799å·", desc: "", grade: "C", district: "åŒå®‰åŒº"},
            {name: "å¦é—¨åŒå®‰çˆ±ç´æµ·è´­ç‰©ä¸­å¿ƒ", lat: 24.661295, lng: 118.174477, address: "è¥¿æŸ¯é•‡æ™ºè°·ä¸œä¸‰è·¯8å·", desc: "", grade: "B", district: "åŒå®‰åŒº"},
            {name: "è§…å…‰é‡Œ", lat: 24.664209, lng: 118.193122, address: "æ»¨æµ·é‡Œ1å·", desc: "", grade: "C", district: "ç¿”å®‰åŒº"}
        ];

        var allMarkers = [];
        xiamen_malls.forEach(function(mall) {
            const style = districtStyles[mall.district] || districtStyles["æ€æ˜åŒº"];
            
            let gradeClass = "grade-none";
            if (mall.grade === "A+") gradeClass = "grade-Aplus";
            else if (mall.grade === "A") gradeClass = "grade-A";
            else if (mall.grade === "A-") gradeClass = "grade-Aminus";
            else if (mall.grade === "B") gradeClass = "grade-B";
            else if (mall.grade === "C") gradeClass = "grade-C";
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <h3 style="margin:0 0 5px; font-size:16px;">${mall.name}</h3>
                    <div style="margin-bottom:8px;">
                        <span class="grade-badge ${gradeClass}">${mall.grade || 'æœªè¯„çº§'}</span>
                        <span style="color:#666; font-size:12px;">${mall.district}</span>
                    </div>
                    <div style="color:#555; font-size:13px; margin-bottom:10px;">${mall.address}</div>
                    <button class="popup-search-btn" onclick="openPoiSearch(${mall.lat}, ${mall.lng}, '${mall.name}')">ğŸ” æœå‘¨è¾¹ (å’–å•¡/åœè½¦/ç¾é£Ÿ)</button>
                </div>
            `;
            
            const marker = L.marker([mall.lat, mall.lng], {icon: style.icon})
                .addTo(map)
                .bindPopup(popupContent);

            marker.bindTooltip(mall.name, {
                permanent: true,
                direction: 'top',
                className: 'map-label-base mall-label', 
                offset: [0, -38]
            }).closeTooltip();

            allMarkers.push(marker);
        });

        var info = L.control({position: "topleft"});
        info.onAdd = function (map) {
            var div = L.DomUtil.create("div", "panel-card info-panel");
            div.innerHTML = "<h4>å¦é—¨å•†ä¸šåœ°å›¾ 2025</h4>" +
                "<div>å…±å½•å…¥ " + xiamen_malls.length + " ä¸ªå•†ä¸šä½“</div>";
            return div;
        };
        info.addTo(map);

        var legend = L.control({position: "bottomleft"});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create("div", "panel-card info-panel legend");
            let content = "<strong>è¡Œæ”¿åŒºåˆ’</strong><br>";
            for (const key in districtStyles) {
                content += `<div style='margin-bottom:4px;'><i style='background: ${districtStyles[key].color}'></i> ${key}</div>`;
            }
            content += "<hr style='border:0; border-top:1px solid #eee; margin:8px 0;'><strong>é¡¹ç›®è¯„çº§</strong><br>" +
                "<span class='grade-badge grade-Aplus'>A+</span> åŸå¸‚çº§åœ°æ ‡<br>" +
                "<span class='grade-badge grade-A'>A</span> åŒºåŸŸçº§ä¸­å¿ƒ<br>" +
                "<span class='grade-badge grade-B'>B</span> ç¤¾åŒºçº§ä¸­å¿ƒ";
            div.innerHTML = content;
            return div;
        };
        legend.addTo(map);

        // 5. POI æœç´¢åŠŸèƒ½ (å åŠ æ¨¡å¼)
        const amapApiKey = "c85d0ca7bc7107f785cc9d85cd400637";
        const poiSearchModal = document.getElementById('poi-search-modal');
        const poiResultsContainer = document.getElementById('poi-results');
        const clearPoiBtn = document.getElementById('clear-poi-btn');
        let poiMarkersLayer = L.layerGroup().addTo(map);
        let currentSearchCenter = null;

        window.openPoiSearch = function(lat, lng, mallName) {
            currentSearchCenter = { lat, lng };
            document.getElementById('poi-modal-title').innerText = `åœ¨ ${mallName} å‘¨è¾¹æŸ¥æ‰¾`;
            poiSearchModal.style.display = 'flex';
            // æ³¨æ„ï¼šæ‰“å¼€æ–°å•†åœºæœç´¢æ—¶ï¼Œæ‚¨å¯ä»¥é€‰æ‹©æ¸…ç©ºä¹‹å‰çš„åˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥ä¿ç•™ã€‚
            // å¦‚æœæƒ³ä¿ç•™ä¹‹å‰çš„æœç´¢å†å²ï¼Œè¯·æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œï¼š
            // poiResultsContainer.innerHTML = ''; 
            document.getElementById('poi-keyword-input').focus();
        }

        document.getElementById('poi-modal-close-btn').onclick = () => poiSearchModal.style.display = 'none';

        // æ‰§è¡Œæœç´¢ (å åŠ é€»è¾‘)
        document.getElementById('poi-search-btn').onclick = async function() {
            const btn = this;
            const input = document.getElementById('poi-keyword-input');
            const keyword = input.value;
            
            if (!keyword || !currentSearchCenter) return;

            const originalBtnText = btn.innerText;
            btn.innerText = "â³ æœç´¢ä¸­...";
            btn.disabled = true;
            
            const location = `${currentSearchCenter.lng},${currentSearchCenter.lat}`;
            const url = `https://restapi.amap.com/v3/place/around?key=${amapApiKey}&location=${location}&keywords=${encodeURIComponent(keyword)}&radius=2000&offset=20&page=1&extensions=all`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === '1' && data.pois.length > 0) {
                    // æ·»åŠ ä¸€ä¸ªåˆ†éš”æ ‡é¢˜ï¼Œæ ‡ç¤ºè¿™æ‰¹æœç´¢æ˜¯ä»€ä¹ˆ
                    const header = document.createElement('div');
                    header.className = 'poi-batch-header';
                    header.innerText = `ğŸ” æœç´¢: "${keyword}" (${data.pois.length}ä¸ª)`;
                    poiResultsContainer.prepend(header); // å°†æ–°ç»“æœæ”¾å‰é¢ï¼Œæˆ–è€…ç”¨ appendChild æ”¾åé¢

                    displayPoiResults(data.pois);
                    clearPoiBtn.style.display = 'block';
                    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†æ–¹ä¾¿ä¸‹æ¬¡æœç´¢
                } else {
                    alert('æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹');
                }
            } catch (error) {
                console.error(error);
                alert('æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
            } finally {
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        };

        function displayPoiResults(pois) {
            const poiIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div class='marker-pin'></div>",
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            pois.forEach(poi => {
                const [lng, lat] = poi.location.split(',');
                const marker = L.marker([lat, lng], { icon: poiIcon }).addTo(poiMarkersLayer);
                
                marker.bindPopup(`<b>${poi.name}</b><br><span style='font-size:12px;color:#666'>${poi.address}</span>`);
                
                marker.bindTooltip(poi.name, {
                    permanent: true,
                    direction: 'top',
                    className: 'map-label-base poi-label', 
                    offset: [0, -10]
                });

                const div = document.createElement('div');
                div.className = 'poi-item';
                div.innerHTML = `<span>${poi.name}</span><span>${poi.distance}m</span>`;
                
                // æ–°ç»“æœæ’å…¥åˆ°æ ‡é¢˜ä¹‹å
                // ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æ’åˆ°å®¹å™¨æœ€å‰é¢ï¼ˆå°±åœ¨æ ‡é¢˜åé¢ï¼‰
                // å¦‚æœä½¿ç”¨ appendChildï¼Œç»“æœä¼šåœ¨åˆ—è¡¨åº•éƒ¨
                // è¿™é‡Œé…åˆ prepend(header) ä½¿ç”¨ insertAfter é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œ
                // ç®€å•ç­–ç•¥ï¼šå…¨éƒ¨ appendChild åˆ°åˆ—è¡¨åº•éƒ¨ï¼Œæˆ–è€…å…¨éƒ¨ insertAdjacentElement
                
                // ä¿®æ­£ç­–ç•¥ï¼šä¸ºäº†è§†è§‰æ¸…æ™°ï¼Œæˆ‘ä»¬å°†æ–°ç»“æœæ·»åŠ åˆ°åˆ—è¡¨ **é¡¶éƒ¨** (Headerå·²ç»åœ¨é¡¶éƒ¨äº†)
                // è¿™æ ·ç”¨æˆ·ä¸ç”¨æ»šåŠ¨åˆ°åº•éƒ¨å°±èƒ½çœ‹åˆ°æœ€æ–°ç»“æœ
                if (poiResultsContainer.firstChild && poiResultsContainer.firstChild.className === 'poi-batch-header') {
                     poiResultsContainer.firstChild.insertAdjacentElement('afterend', div);
                } else {
                     poiResultsContainer.appendChild(div);
                }

                div.onclick = () => {
                    map.setView([lat, lng], 16);
                    marker.openPopup();
                };
            });
        }

        // æ¸…é™¤é€»è¾‘ï¼šåŒæ—¶æ¸…é™¤åˆ—è¡¨å’Œåœ°å›¾
        clearPoiBtn.onclick = function() {
            if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å‘¨è¾¹æœç´¢ç»“æœå—ï¼Ÿ')) {
                poiMarkersLayer.clearLayers(); // æ¸…é™¤åœ°å›¾ç‚¹
                poiResultsContainer.innerHTML = ''; // æ¸…é™¤åˆ—è¡¨
                clearPoiBtn.style.display = 'none';
            }
        };

        var measureControl = L.control.measure({
            position: 'topleft', 
            primaryLengthUnit: 'meters', 
            secondaryLengthUnit: 'kilometers',
            activeColor: '#2563eb',
            completedColor: '#1d4ed8',
            localization: 'cn'
        });
        measureControl.addTo(map);
        
        setTimeout(() => {
            const measureContainer = document.querySelector('.leaflet-control-measure');
            const radiusPanel = document.querySelector('#radius-control .control-header').nextElementSibling;
            if (measureContainer && radiusPanel) {
                radiusPanel.parentNode.insertBefore(measureContainer, radiusPanel);
            }
        }, 500);

        let radiusCircles = [];
        let isInRadiusMode = false;
        const radiusButton = document.getElementById('radius-button');
        
        radiusButton.onclick = function(e) {
            e.stopPropagation();
            isInRadiusMode = true;
            map.getContainer().style.cursor = 'crosshair';
            radiusButton.innerHTML = "ğŸ–±ï¸ è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä¸­å¿ƒç‚¹...";
            radiusButton.style.background = "#f59e0b";
        };

        map.on('click', function(e) {
            if (!isInRadiusMode) return;
            
            const radiusVal = parseFloat(document.getElementById('radius-input').value);
            const unit = document.getElementById('radius-unit').value;
            const radiusInMeters = unit === 'kilometers' ? radiusVal * 1000 : radiusVal;

            createAnalysisCircle(e.latlng, radiusInMeters);
            
            isInRadiusMode = false;
            map.getContainer().style.cursor = '';
            radiusButton.innerHTML = "ğŸ¯ ç‚¹å‡»åœ°å›¾é€‰ç‚¹åˆ†æ";
            radiusButton.style.background = "";
        });

        function createAnalysisCircle(latlng, radiusMeters) {
            const color = '#2563eb';
            
            const circle = L.circle(latlng, {
                radius: radiusMeters,
                color: color,
                fillColor: color,
                fillOpacity: 0.15,
                weight: 2
            }).addTo(map);

            const mallsIn = xiamen_malls.filter(m => {
                return latlng.distanceTo(L.latLng(m.lat, m.lng)) <= radiusMeters;
            });

            const recordId = Date.now();
            radiusCircles.push({ id: recordId, circle: circle, center: latlng, radius: radiusMeters, malls: mallsIn });

            updateMallLabelsVisibility();
            renderRecordsList();
            
            document.getElementById('clear-all-btn').style.display = 'block';
        }

        function updateMallLabelsVisibility() {
            allMarkers.forEach(marker => {
                const mLatLng = marker.getLatLng();
                let inside = false;
                
                for (let c of radiusCircles) {
                    if (c.center.distanceTo(mLatLng) <= c.radius) {
                        inside = true;
                        break;
                    }
                }

                if (inside) marker.openTooltip();
                else marker.closeTooltip();
            });
        }

        function renderRecordsList() {
            const list = document.getElementById('records-list');
            list.innerHTML = '';
            
            if (radiusCircles.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:20px;color:#999">æš‚æ— è®°å½•</div>';
                return;
            }

            radiusCircles.forEach((record, idx) => {
                const div = document.createElement('div');
                div.className = 'record-item';
                div.style.borderLeftColor = record.malls.length > 0 ? '#10b981' : '#9ca3af';
                
                const names = record.malls.map(m => m.name).join(', ');
                
                div.innerHTML = `
                    <div class="record-actions">
                        <strong>åˆ†æ #${idx + 1}</strong>
                        <button class="btn-xs btn-danger" onclick="removeRecord(${record.id})">åˆ é™¤</button>
                    </div>
                    <div style="color:#555; margin-bottom:4px;">åŠå¾„: ${Math.round(record.radius)}ç±³ | åŒ…å«: <b>${record.malls.length}</b> ä¸ª</div>
                    <div style="font-size:11px; color:#666; line-height:1.4;">${names || 'æ— å•†ä¸šé¡¹ç›®'}</div>
                `;
                list.appendChild(div);
            });
        }

        window.removeRecord = function(id) {
            const idx = radiusCircles.findIndex(r => r.id === id);
            if (idx > -1) {
                map.removeLayer(radiusCircles[idx].circle);
                radiusCircles.splice(idx, 1);
                updateMallLabelsVisibility();
                renderRecordsList();
            }
            if (radiusCircles.length === 0) document.getElementById('clear-all-btn').style.display = 'none';
        };

        document.getElementById('clear-all-btn').onclick = function() {
            radiusCircles.forEach(r => map.removeLayer(r.circle));
            radiusCircles = [];
            updateMallLabelsVisibility();
            renderRecordsList();
            this.style.display = 'none';
        };

        const radiusControl = document.getElementById('radius-control');
        const toggleBtn = document.getElementById('toggle-control');
        const showBtn = document.getElementById('show-control-btn');

        toggleBtn.onclick = () => {
            radiusControl.style.transform = 'translateX(120%)';
            setTimeout(() => {
                radiusControl.style.display = 'none';
                showBtn.style.display = 'block';
            }, 300);
        };

        showBtn.onclick = () => {
            showBtn.style.display = 'none';
            radiusControl.style.display = 'flex';
            setTimeout(() => radiusControl.style.transform = 'translateX(0)', 10);
        };

        function makeDraggable(el, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                if (['INPUT','BUTTON','SELECT'].includes(e.target.tagName)) return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                el.style.top = (el.offsetTop - pos2) + "px";
                el.style.left = (el.offsetLeft - pos1) + "px";
                el.style.right = 'auto';
            }
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        makeDraggable(radiusControl, document.querySelector('.control-header'));
        makeDraggable(poiSearchModal, document.querySelector('#poi-search-modal .control-header'));

    </script>
</body>
</html>