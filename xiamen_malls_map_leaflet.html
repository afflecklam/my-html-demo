<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>å¦é—¨å¸‚é‡ç‚¹è´­ç‰©ä¸­å¿ƒåœ°å›¾ (2025å¹´)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #007bff;
            --primary-hover-color: #0056b3;
            --danger-color: #dc3545;
            --danger-hover-color: #c82333;
            --secondary-color: #6c757d;
            --secondary-hover-color: #5a6268;
            --light-gray-color: #f8f9fa;
            --medium-gray-color: #e9ecef;
            --dark-gray-color: #6c757d;
            --font-color: #343a40;
            --font-color-light: #6c757d;
            --background-color: #ffffff;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f4f4f4;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .info {
            padding: 12px 15px;
            background: var(--background-color);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            line-height: 1.6;
            color: var(--font-color);
            font-size: 14px;
            cursor: move;
            user-select: none;
        }
        
        .info h4 {
            cursor: move;
            user-select: none;
            margin: 0 0 10px;
            color: var(--font-color);
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid var(--medium-gray-color);
            padding-bottom: 8px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            border-radius: 50%;
            opacity: 0.9;
        }
        .legend .project-grade {
            margin-bottom: 4px;
        }

        .popup-content {
            max-width: 300px;
            font-size: 14px;
            line-height: 1.7;
        }
        .popup-content b {
            font-weight: 600;
            color: var(--font-color);
        }
        .popup-content .poi-search-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }
        .popup-content .poi-search-btn:hover {
            background-color: var(--primary-hover-color);
        }

        .project-grade {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            font-size: 12px;
            margin: 4px 0;
        }

        .grade-Aplus { background-color: #d73027; }
        .grade-A { background-color: #f46d43; }
        .grade-Aminus { background-color: #fdae61; }
        .grade-B { background-color: #4575b4; }
        .grade-C { background-color: #abd9e9; color: #333; }
        .grade-none { background-color: #e0e0e0; color: #555; }

        #radius-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--background-color);
            padding: 20px;
            border-radius: var(--border-radius);
            z-index: 1000;
            box-shadow: var(--box-shadow);
            width: 280px;
            max-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: move;
            user-select: none;
        }
        
        .control-header {
            cursor: move;
            user-select: none;
        }
        
        .control-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray-color);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .control-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--font-color);
            margin: 0;
        }
        .toggle-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-speed);
        }
        .toggle-btn:hover {
            background: var(--secondary-hover-color);
        }
        .control-subtitle {
            font-size: 13px;
            color: var(--font-color-light);
            margin: 5px 0 0;
        }

        #radius-control .toggle-btn::before {
            content: 'âœ•';
            font-weight: normal;
        }

        #radius-control input, #radius-control select {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        #radius-control input:focus, #radius-control select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        #radius-control button {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            transition: background-color var(--transition-speed), transform var(--transition-speed);
        }
        #radius-control button:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }

        .tab-container {
            display: flex;
            margin-bottom: 15px;
            background-color: var(--light-gray-color);
            border-radius: 6px;
            padding: 4px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px 10px;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: var(--font-color-light);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        .tab-btn.active {
            background-color: var(--background-color);
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #records-section {
            margin-top: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .records-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        #no-records {
            text-align: center;
            padding: 40px 20px;
            color: var(--font-color-light);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .records-stats {
            font-size: 12px;
            color: var(--font-color-light);
            text-align: center;
            margin-bottom: 10px;
            padding: 5px;
            background: var(--light-gray-color);
            border-radius: 4px;
        }
        .records-stats span {
            font-weight: 600;
            color: var(--font-color);
        }

        .record-item {
            background: var(--background-color);
            border: 1px solid var(--medium-gray-color);
            border-left-width: 4px;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 13px;
            transition: box-shadow var(--transition-speed);
        }
        .record-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .record-title {
            font-weight: 700;
            font-size: 15px;
        }
        .record-delete {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color var(--transition-speed);
        }
        .record-delete:hover {
            background: var(--danger-hover-color);
        }

        .record-info {
            color: var(--font-color-light);
            line-height: 1.6;
        }
        .record-info strong {
            color: var(--font-color);
            font-weight: 500;
        }
        .record-info details summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--secondary-color);
            outline: none;
        }
        .record-info details[open] summary {
            color: var(--primary-color);
        }

        .clear-all-btn {
            background: var(--secondary-color) !important;
            color: white !important;
            margin-top: 10px;
        }
        .clear-all-btn:hover {
            background: var(--secondary-hover-color) !important;
        }
        
        .leaflet-control-measure {
            border-radius: var(--border-radius) !important;
            box-shadow: var(--box-shadow) !important;
        }
        .leaflet-control-measure .leaflet-control-measure-toggle,
        .leaflet-control-measure .leaflet-control-measure-toggle:hover {
            border-radius: var(--border-radius) !important;
        }
        
        #radius-mode-prompt {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        /* POI Search Modal Styles */
        #poi-search-modal {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            background: white;
            z-index: 2001;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            flex-direction: column;
        }
        #poi-search-modal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--medium-gray-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        #poi-search-modal .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--font-color);
        }
        #poi-search-modal .modal-close-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--secondary-color);
        }
        #poi-search-modal input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        #poi-search-modal .modal-search-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        #poi-search-modal .modal-search-btn:hover {
            background-color: var(--primary-hover-color);
        }
        #poi-results {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
        }
        #poi-results .poi-item {
            padding: 8px;
            border-bottom: 1px solid var(--light-gray-color);
        }
        #poi-results .poi-item:last-child {
            border-bottom: none;
        }

        /* Style for POI search result markers */
        .marker-pin {
            width: 15px; /* Increased size */
            height: 15px; /* Increased size */
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.6); /* More prominent shadow */
            border: 2px solid white; /* Thicker border */
        }
        .custom-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="radius-control">
        <div class="control-header">
            <div class="header-top">
                <h3 class="control-title">èŒƒå›´æŸ¥è¯¢å·¥å…·</h3>
                <button id="toggle-control" class="toggle-btn" title="éšè—æ§åˆ¶é¢æ¿"></button>
            </div>
            <p class="control-subtitle">ç‚¹å‡»åœ°å›¾ä»»æ„ä½ç½®åˆ›å»ºæŸ¥è¯¢èŒƒå›´ï¼Œåˆ†æå‘¨è¾¹å•†ä¸šåˆ†å¸ƒ</p>
        </div>
        
        <input type="number" id="radius-input" value="1" min="0.1" step="0.1" title="è¾“å…¥åŠå¾„" placeholder="è¾“å…¥æŸ¥è¯¢åŠå¾„">
        <select id="radius-unit" title="é€‰æ‹©å•ä½">
            <option value="kilometers">å…¬é‡Œ (km)</option>
            <option value="meters">ç±³ (m)</option>
        </select>
        <button id="radius-button">ğŸ¯ å¼€å§‹èŒƒå›´æŸ¥è¯¢</button>
        
        <div id="records-section">
            <div class="tab-container">
                <button class="tab-btn active" id="current-tab">å½“å‰èŒƒå›´</button>
                <button class="tab-btn" id="history-tab">å†å²è®°å½•</button>
            </div>
            
            <div class="records-stats" id="records-stats" style="display: none;">
                <span id="total-records">0</span> ä¸ªæŸ¥è¯¢è®°å½• | å…±å‘ç° <span id="total-malls">0</span> ä¸ªå•†åœº
            </div>
            
            <div class="records-list" id="records-list">
                <div id="no-records">æš‚æ— æŸ¥è¯¢è®°å½•<br>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹èŒƒå›´æŸ¥è¯¢</div>
            </div>
            <button class="clear-all-btn" id="clear-all-btn" style="display: none;">ğŸ—‘ï¸ æ¸…é™¤èŒƒå›´è®°å½•</button>
            <button class="clear-all-btn" id="clear-poi-btn" style="display: none; margin-top: 5px;">âœ¨ æ¸…é™¤æœç´¢ç»“æœ</button>
        </div>
    </div>

    <!-- POI Search Modal -->
    <div id="poi-search-modal">
        <div class="modal-header">
            <span id="poi-modal-title" class="modal-title">å‘¨è¾¹æœç´¢</span>
            <button id="poi-modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <input type="text" id="poi-keyword-input" placeholder="ä¾‹å¦‚: å’–å•¡, é¤å…, å……ç”µç«™">
        <button id="poi-search-btn" class="modal-search-btn">æœç´¢</button>
        <div id="poi-results"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.chinesetmsproviders@1.0.22/src/leaflet.ChineseTmsProviders.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@2.1.7/dist/leaflet-measure.cn.js"></script>
    <script>
        var map = L.map("map").setView([24.48, 118.12], 12);

        L.tileLayer.chinaProvider('GaoDe.Normal.Map', {
            maxZoom: 18,
            minZoom: 10,
            attribution: 'é«˜å¾·åœ°å›¾'
        }).addTo(map);
        
        const districtStyles = {
            "æµ·æ²§åŒº": { color: "#e41a1c", name: "æµ·æ²§åŒº" },
            "é›†ç¾åŒº": { color: "#377eb8", name: "é›†ç¾åŒº" },
            "åŒå®‰åŒº": { color: "#4daf4a", name: "åŒå®‰åŒº" },
            "æ€æ˜åŒº": { color: "#ff7f00", name: "æ€æ˜åŒº" },
            "ç¿”å®‰åŒº": { color: "#ffd700", name: "ç¿”å®‰åŒº" },
            "æ¹–é‡ŒåŒº": { color: "#ffff33", name: "æ¹–é‡ŒåŒº" }
        };

        function createColoredIcon(color) {
            const svgIcon = window.btoa(`
                <svg width="25" height="41" viewBox="0 0 25 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 0C5.596 0 0 5.596 0 12.5C0 19.404 5.596 25 12.5 25C19.404 25 25 19.404 25 12.5C25 5.596 19.404 0 12.5 0Z" fill="${color}"/>
                    <path d="M12.5 35.5C18.299 35.5 23 30.799 23 25H2C2 30.799 6.701 35.5 12.5 35.5Z" fill="${color}"/>
                    <circle cx="12.5" cy="12.5" r="6" fill="#ffffff"/>
                </svg>
            `);

            return L.icon({
                iconUrl: `data:image/svg+xml;base64,${svgIcon}`,
                shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }

        for (const key in districtStyles) {
            districtStyles[key].icon = createColoredIcon(districtStyles[key].color);
        }

        var xiamen_malls = [
            {name: "å¦é—¨ä¸‡è±¡åŸ", lat: 24.472250, lng: 118.111010, address: "æ¹–æ»¨ä¸œè·¯99å·(æ¹–æ»¨ä¸œè·¯åœ°é“ç«™6å·å£æ­¥è¡Œ60ç±³)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ä¸­ååŸ", lat: 24.452752, lng: 118.082665, address: "æ€æ˜å—è·¯195å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å®é¾™ä¸€åŸ", lat: 24.485801, lng: 118.172970, address: "é‡‘å±±è·¯1å·(å²­å…œåœ°é“ç«™1Aå£æ­¥è¡Œ50ç±³)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç£åŸºåå“ä¸­å¿ƒ", lat: 24.481554, lng: 118.120682, address: "è²èŠ±è·¯å£åœ°é“ç«™1Aå£æ­¥è¡Œ160ç±³", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç£åŸºè²èŠ±é‡Œ", lat: 24.484334, lng: 118.127433, address: "è²èŠ±åŒ—è·¯ä¸å˜‰è²é‡Œäº¤å‰å£ä¸œå—100ç±³", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ä¸–èŒ‚æµ·å³¡å¤§å¦", lat: 24.435581, lng: 118.088740, address: "æ¼”æ­¦è¥¿è·¯180-188å·(å¦å¤§åŒ»é™¢æ—)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨ç¦¹æ‚¦æ±‡", lat: 24.467780, lng: 118.113791, address: "å¦ç¦¾è·¯882-888å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç½—å®¾æ£®å¹¿åœº", lat: 24.468932, lng: 118.112681, address: "å¦ç¦¾è·¯899å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¤©è™¹è´­ç‰©ä¸­å¿ƒ(å¦é—¨ç­¼ç­œåº—)", lat: 24.491751, lng: 118.113856, address: "è²å²³è·¯221å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¤©è™¹å•†åœº(æ±‡è…¾åº—)", lat: 24.491451, lng: 118.127272, address: "å˜‰ç¦¾è·¯323å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "æ±‡æˆå•†ä¸šä¸­å¿ƒ", lat: 24.466493, lng: 118.104231, address: "æ¹–æ»¨ä¸­è·¯6å·(æ–‡ç¶åœ°é“ç«™2å·å£æ—)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç¦æ˜Ÿå•†ä¸šä¸­å¿ƒ", lat: 24.491876, lng: 118.133532, address: "å•å²­è·¯120å·(æ±Ÿå¤´åœ°é“ç«™2Aå£æ­¥è¡Œ390ç±³)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç‘æ™¯å•†ä¸šå¹¿åœº(è²å‰ä¸œè·¯)", lat: 24.475070, lng: 118.159704, address: "è²å‰ä¸œè·¯288å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "è€è™åŸæ¬¢ä¹è´­ç‰©ä¸­å¿ƒ", lat: 24.453026, lng: 118.080980, address: "æ€æ˜å—è·¯ä¸­æ®µæ°‘ç››å•†å¦åœ°ä¸‹ä¸€å±‚", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "åŠ å·å•†ä¸šå¹¿åœº", lat: 24.477278, lng: 118.158174, address: "è²å‰ä¸œè·¯123å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æ‚¦äº«(ä¸­å¿ƒåº—)", lat: 24.494703, lng: 118.112998, address: "æ¾å²³è·¯8å·å»ºå‘Â·æ‚¦äº«ä¸­å¿ƒF2å±‚", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æ˜Ÿæ²³COCO Park", lat: 24.474718, lng: 118.189093, address: "å±•é¸¿è·¯81-89å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨æµ·å³¡ä¸–èŒ‚å¹¿åœº", lat: 24.435581, lng: 118.088740, address: "æ¼”æ­¦è¥¿è·¯180-188å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "å¦é—¨èˆªç©º", lat: 24.468098, lng: 118.167658, address: "å‰åŸ”å…­é‡Œä¸å‰åŸ”å—è·¯äº¤å‰å£è¥¿åŒ—60ç±³", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "è½¯ä»¶å›­ç”Ÿæ´»å¹¿åœº", lat: 24.484360, lng: 118.176763, address: "å²­å…œè¥¿è·¯623å·(å²­å…œåœ°é“ç«™3å·å£æ­¥è¡Œ290ç±³)", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ä¸œæ–¹æ—¶ä»£è´­ç‰©å¹¿åœº", lat: 24.461486, lng: 118.079863, address: "æ¹–æ»¨è¥¿è·¯12å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "æ€æ˜æ¬¢ä¹é¢‚å•†åœº", lat: 24.486296, lng: 118.095641, address: "ä¸ƒæ˜Ÿè¥¿è·¯3å·", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "æ˜å‘å•†ä¸šå¹¿åœº", lat: 24.478639, lng: 118.123245, address: "è²å‰è¥¿è·¯ä¸å˜‰ç¦¾è·¯äº¤æ±‡å¤„ä¸œåŒ—è§’", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "ç¦¾ç¥¥é‘«å¤©åœ°(è£…ä¿®ä¸­)", lat: 24.468854, lng: 118.105113, address: "ååŸ­æºªè·¯ä¸é‡‘æ¦œè¥¿å››è·¯äº¤å‰å£è¥¿180ç±³", desc: "", grade: "", district: "æ€æ˜åŒº"},
            {name: "SMåŸå¸‚å¹¿åœº(å¦é—¨æ¹–é‡Œåº—)", lat: 24.500849, lng: 118.126101, address: "å˜‰ç¦¾è·¯468å·", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æ¹–é‡Œä¸‡è¾¾å¹¿åœº", lat: 24.504657, lng: 118.177299, address: "ä»™å²³è·¯4666å·1Få±‚105å·å•†é“º", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨è”¡å¡˜çˆ±ç´æµ·è´­ç‰©ä¸­å¿ƒ", lat: 24.485380, lng: 118.156300, address: "å•å²­è·¯1068å·(è”¡å¡˜åœ°é“ç«™4Bå£æ­¥è¡Œ400ç±³)", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¤©è™¹è´­ç‰©ä¸­å¿ƒ(äº”ç¼˜æ¹¾åº—)", lat: 24.509873, lng: 118.160382, address: "é‡‘æ¹–è·¯516å·", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å˜‰ç¦¾æ–°å¤©åœ°", lat: 24.512903, lng: 118.119287, address: "ç«ç‚¬è·¯1å·(ç«ç‚¬å›­åœ°é“ç«™4å·å£æ—)", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "æ¹¾æ‚¦åŸ", lat: 24.515630, lng: 118.161623, address: "æ—¥åœ†äºŒé‡Œ1å·", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æµ·ä¸Šä¸–ç•Œè´­ç‰©ä¸­å¿ƒ", lat: 24.490000, lng: 118.076122, address: "è¿œèˆªè·¯77å·å¦é—¨æµ·ä¸Šä¸–ç•Œ405A", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¾æ‚¦å®¶å±…(å¦é—¨æ’è¾‰å•†åŠ¡ä¸­å¿ƒåº—)", lat: 24.528930, lng: 118.157583, address: "å²­ä¸‹å—è·¯77å·å¦é—¨æ’è¾‰å•†åŠ¡ä¸­å¿ƒ", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨é¹­æ¸¯", lat: 24.522193, lng: 118.109526, address: "é•¿ä¹è·¯350å·", desc: "", grade: "", district: "æ¹–é‡ŒåŒº"},
            {name: "å¦é—¨æµ·æ²§æ‹›å•†èŠ±å›­åŸ", lat: 24.536560, lng: 117.997334, address: "æ–°æ™¯ä¸œé‡Œ200å·(åœ°é“2å·çº¿æ–°é˜³å¤§é“3å·å‡ºå£)", desc: "", grade: "", district: "æµ·æ²§åŒº"},
            {name: "ä¸­å»ºé—½æ³°å»ºè®¾å¼€å‘æœ‰é™å…¬å¸å¦é—¨SMé©¬éŠ®æ¹¾é¡¹ç›®ç®¡ç†éƒ¨(å»ºè®¾ä¸­)", lat: 24.539346, lng: 117.956065, address: "å­šè²è·¯ä¸ä¸œå­šè¥¿è·¯äº¤å‰å£ä¸œå—çº¦160ç±³", desc: "", grade: "", district: "æµ·æ²§åŒº"},
            {name: "è¥¿é›…å›¾è´­ç‰©ä¸­å¿ƒ", lat: 24.493055, lng: 118.028228, address: "é©¬é’è·¯ä¸é’Ÿæ—è·¯äº¤æ±‡å¤„(åœ°é“é©¬é’è·¯ç«™)", desc: "", grade: "", district: "æµ·æ²§åŒº"},
            {name: "é˜¿ç½—æµ·åŸå¸‚å¹¿åœº", lat: 24.480404, lng: 118.032116, address: "æ»¨æ¹–åŒ—äºŒè·¯70å·", desc: "", grade: "", district: "æµ·æ²§åŒº"},
            {name: "å¦é—¨å°šæŸå¥¥ç‰¹è±æ–¯", lat: 24.621979, lng: 118.072913, address: "åå¤è·¯1å·", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨å¤§æ‚¦åŸ", lat: 24.592382, lng: 118.055468, address: "è¯šæ¯…ä¸­è·¯ä¸ææ—æ¹¾è·¯äº¤å‰å£è¥¿140ç±³", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨é¾™æ¹–é›†ç¾å¤©è¡—(è£…ä¿®ä¸­)", lat: 24.585352, lng: 118.052448, address: "æé”¦è·¯è¾…è·¯ä¸æåŒ—è·¯äº¤å‰å£å—140ç±³", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨å’Œç¾å¤©åœ°", lat: 24.604974, lng: 118.051339, address: "è¥¿äº­åŒ—äºŒè·¯ä¸è¯šæ¯…å¤§è¡—äº¤å‰å£è¥¿140ç±³", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "ä¸‡è¾¾å¹¿åœº(å¦é—¨ææ—åº—)", lat: 24.590956, lng: 118.013908, address: "æå‰è·¯262-101å·ä¹‹äºŒ", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "iOi MALL", lat: 24.600689, lng: 118.075097, address: "æ»¨æ°´è·¯ä¸­äº”é‡Œ1å·", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "ä¸‡è¾¾å¹¿åœº(å¦é—¨é›†ç¾åº—)", lat: 24.573357, lng: 118.092658, address: "é“¶æ±Ÿè·¯137å·", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨é›†ç¾ä¸–èŒ‚å¹¿åœº", lat: 24.602113, lng: 118.076472, address: "ä¾¨è‹±è¡—é“æ»¨æ°´ä¸­äºŒé‡Œ32-33å·", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¤§æ˜å¹¿åœº", lat: 24.592825, lng: 118.052483, address: "ç«‹è¨€è·¯ä¸æœæ—­è·¯äº¤å‰å£å—140ç±³", desc: "", grade: "", district: "é›†ç¾åŒº"},
            {name: "å¦é—¨åŒå®‰å®é¾™å¹¿åœº", lat: 24.716671, lng: 118.165639, address: "ç¯åŸå—è·¯799å·", desc: "", grade: "", district: "åŒå®‰åŒº"},
            {name: "å¦é—¨åŒå®‰çˆ±ç´æµ·è´­ç‰©ä¸­å¿ƒ", lat: 24.661295, lng: 118.174477, address: "è¥¿æŸ¯é•‡æ™ºè°·ä¸œä¸‰è·¯8å·", desc: "", grade: "", district: "åŒå®‰åŒº"},
            {name: "è§…å…‰é‡Œ", lat: 24.664209, lng: 118.193122, address: "æ»¨æµ·é‡Œ1å·", desc: "", grade: "", district: "ç¿”å®‰åŒº"}
        ];
        
        xiamen_malls.forEach(function(mall) {
            const style = districtStyles[mall.district] || districtStyles["æ€æ˜åŒº"];
            if (!style) {
                console.warn(`District "${mall.district}" not found in styles.`);
                return;
            }

            var gradeClass = "grade-none";
            if (mall.grade === "A+") gradeClass = "grade-Aplus";
            else if (mall.grade === "A") gradeClass = "grade-A";
            else if (mall.grade === "A-") gradeClass = "grade-Aminus";
            else if (mall.grade === "B") gradeClass = "grade-B";
            else if (mall.grade === "C") gradeClass = "grade-C";
            
            var popupContent = `<div class="popup-content">
                <b>${mall.name}</b><br>
                <span class="project-grade ${gradeClass}">${mall.grade || 'æœªè¯„çº§'}</span><br>
                <b>åŒºåŸŸï¼š</b>${mall.district}<br>
                <b>åœ°å€ï¼š</b>${mall.address}<br>
                <button class="poi-search-btn" onclick="openPoiSearch(${mall.lat}, ${mall.lng}, '${mall.name}')">æœç´¢å‘¨è¾¹</button>
            </div>`;
            
            L.marker([mall.lat, mall.lng], {icon: style.icon})
                .addTo(map)
                .bindPopup(popupContent);
        });
        
        var legend = L.control({position: "bottomright"});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create("div", "info legend");
            let content = "<h4>è¡Œæ”¿åŒºå›¾ä¾‹</h4>";
            for (const key in districtStyles) {
                const style = districtStyles[key];
                content += `<i style='background: ${style.color}'></i> ${key}<br>`;
            }
            
            content += "<br><h4>é¡¹ç›®ç­‰çº§</h4>" +
                "<span class='project-grade grade-Aplus'>A+</span> é¡¶çº§é¡¹ç›®<br>" +
                "<span class='project-grade grade-A'>A</span> ä¼˜ç§€é¡¹ç›®<br>" +
                "<span class='project-grade grade-Aminus'>A-</span> è‰¯å¥½é¡¹ç›®<br>" +
                "<span class='project-grade grade-B'>B</span> ä¸€èˆ¬é¡¹ç›®<br>" +
                "<span class='project-grade grade-C'>C</span> åŸºç¡€é¡¹ç›®<br>" +
                "<span class='project-grade grade-none'>æœªè¯„çº§</span> ä¿¡æ¯å¾…è¡¥å……";

            div.innerHTML = content;
            return div;
        };
        legend.addTo(map);
        
        var info = L.control({position: "topright"});
        info.onAdd = function (map) {
            var div = L.DomUtil.create("div", "info");
            div.innerHTML = "<h4>å¦é—¨å¸‚é‡ç‚¹è´­ç‰©ä¸­å¿ƒåˆ†å¸ƒå›¾ (2025å¹´)</h4>" +
                "<p>å…±" + xiamen_malls.length + "ä¸ªè´­ç‰©ä¸­å¿ƒï¼Œæ¶µç›–6å¤§è¡Œæ”¿åŒº</p>" +
                "<p>ç‚¹å‡»æ ‡è®°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>";
            return div;
        };
        info.addTo(map);

        // --- POI Search Feature ---
        const amapApiKey = "c85d0ca7bc7107f785cc9d85cd400637";
        const poiSearchModal = document.getElementById('poi-search-modal');
        const poiModalTitle = document.getElementById('poi-modal-title');
        const poiKeywordInput = document.getElementById('poi-keyword-input');
        const poiSearchBtn = document.getElementById('poi-search-btn');
        const poiModalCloseBtn = document.getElementById('poi-modal-close-btn');
        const poiResultsContainer = document.getElementById('poi-results');
        const clearPoiBtn = document.getElementById('clear-poi-btn');
        let poiMarkersLayer = L.layerGroup().addTo(map);
        let currentSearchCenter = null;

        function openPoiSearch(lat, lng, mallName) {
            currentSearchCenter = { lat, lng };
            poiModalTitle.textContent = `åœ¨â€œ${mallName}â€å‘¨è¾¹æœç´¢`;
            poiSearchModal.style.display = 'flex';
            poiResultsContainer.innerHTML = ''; // Clear previous list results
        }

        function closePoiSearch() {
            poiSearchModal.style.display = 'none';
            // Markers are intentionally not cleared
        }

        function clearPoiResults() {
            poiMarkersLayer.clearLayers();
            if (clearPoiBtn) {
                clearPoiBtn.style.display = 'none';
            }
        }

        async function executePoiSearch() {
            const keyword = poiKeywordInput.value;
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            if (!currentSearchCenter) {
                alert('æœªé€‰æ‹©æœç´¢ä¸­å¿ƒç‚¹');
                return;
            }

            poiResultsContainer.innerHTML = 'æ­£åœ¨æœç´¢...';

            const location = `${currentSearchCenter.lng},${currentSearchCenter.lat}`;
            const radius = 3000; // 3km radius as requested
            const url = `https://restapi.amap.com/v3/place/around?key=${amapApiKey}&location=${location}&keywords=${encodeURIComponent(keyword)}&radius=${radius}&offset=50&page=1&extensions=all`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                poiResultsContainer.innerHTML = ''; // Clear "searching..." message
                if (data.status === '1' && data.pois.length > 0) {
                    displayPoiResults(data.pois);
                } else {
                    poiResultsContainer.innerHTML = 'æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ã€‚';
                }
            } catch (error) {
                console.error('POI search failed:', error);
                poiResultsContainer.innerHTML = 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–API Keyã€‚';
            }
        }

        function displayPoiResults(pois) {
            const poiIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#2ecc71;' class='marker-pin'></div>",
                iconSize: [15, 15],
                iconAnchor: [8, 8]
            });
            
            pois.forEach(poi => {
                const [lng, lat] = poi.location.split(',');
                const marker = L.marker([lat, lng], { icon: poiIcon }).addTo(poiMarkersLayer);
                marker.bindPopup(`<b>${poi.name}</b><br>${poi.address || ''}`);
                
                const resultItem = document.createElement('div');
                resultItem.className = 'poi-item';
                resultItem.textContent = `${poi.name} (${poi.distance}ç±³)`;
                poiResultsContainer.appendChild(resultItem);
            });

            if (clearPoiBtn && poiMarkersLayer.getLayers().length > 0) {
                clearPoiBtn.style.display = 'block';
            }
        }

        poiSearchBtn.addEventListener('click', executePoiSearch);
        poiModalCloseBtn.addEventListener('click', closePoiSearch);
        clearPoiBtn.addEventListener('click', clearPoiResults);
        window.openPoiSearch = openPoiSearch;

        // --- Radius/Measure Feature (from Nanjing) ---
        var measureControl = L.control.measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares',
            activeColor: '#db4a39',
            completedColor: '#c85353',
            localization: 'cn'
        });
        measureControl.addTo(map);

        window.addEventListener('load', () => {
            const measureElement = document.querySelector('.leaflet-control-measure');
            const radiusControl = document.getElementById('radius-control');
            const firstElementInPanel = radiusControl.querySelector('.control-header').nextElementSibling;

            if (measureElement && radiusControl && firstElementInPanel) {
                firstElementInPanel.parentNode.insertBefore(measureElement, firstElementInPanel);
                measureElement.style.position = 'relative';
                measureElement.style.top = 'auto';
                measureElement.style.left = 'auto';
                measureElement.style.right = 'auto';
                measureElement.style.margin = '0 0 15px 0';
                measureElement.style.width = '100%';
                measureElement.style.boxShadow = 'none';
            }
        });

        let radiusCircles = [];
        let circleCounter = 1;
        const circleColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];
        const radiusButton = document.getElementById('radius-button');
        const radiusInput = document.getElementById('radius-input');
        const radiusUnit = document.getElementById('radius-unit');
        const recordsList = document.getElementById('records-list');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const noRecords = document.getElementById('no-records');
        let isInRadiusMode = false;

        function exitRadiusMode() {
            if (!isInRadiusMode) return;
            isInRadiusMode = false;
            map.getContainer().style.cursor = '';
            const promptDiv = document.getElementById('radius-mode-prompt');
            if (promptDiv) promptDiv.remove();
        }

        radiusButton.addEventListener('click', function(e) {
            e.stopPropagation();
            isInRadiusMode = true;
            map.getContainer().style.cursor = 'crosshair';
            
            let oldPrompt = document.getElementById('radius-mode-prompt');
            if(oldPrompt) oldPrompt.remove();

            let promptDiv = L.DomUtil.create('div', 'info', map.getContainer().parentElement);
            promptDiv.id = 'radius-mode-prompt';
            promptDiv.style.position = 'absolute';
            promptDiv.style.bottom = '30px';
            promptDiv.style.left = '50%';
            promptDiv.style.transform = 'translateX(-50%)';
            promptDiv.style.zIndex = '2000';
            promptDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.75)';
            promptDiv.style.color = 'white';
            promptDiv.style.padding = '8px 15px';
            promptDiv.style.borderRadius = '30px';
            promptDiv.innerHTML = 'å·²è¿›å…¥èŒƒå›´æŸ¥è¯¢æ¨¡å¼ï¼Œè¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä¸€ä¸ªä¸­å¿ƒç‚¹ã€‚';
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isInRadiusMode) {
                exitRadiusMode();
            }
        });

        function createRadiusCircle(latlng, radiusValue, unit) {
            const radiusInMeters = unit === 'kilometers' ? radiusValue * 1000 : radiusValue;
            const colorIndex = (circleCounter - 1) % circleColors.length;
            const color = circleColors[colorIndex];
            
            const circle = L.circle(latlng, {
                radius: radiusInMeters,
                color: color,
                weight: 2,
                fillColor: color,
                fillOpacity: 0.15
            }).addTo(map);
            
            const mallsInRange = xiamen_malls.filter(mall => {
                const mallLatLng = L.latLng(mall.lat, mall.lng);
                return latlng.distanceTo(mallLatLng) <= radiusInMeters;
            });
            
            const record = {
                id: circleCounter++,
                circle: circle,
                center: latlng,
                radius: radiusValue,
                unit: unit,
                color: color,
                timestamp: new Date(),
                mallsCount: mallsInRange.length,
                malls: mallsInRange
            };
            
            radiusCircles.push(record);
            
            circle.on('contextmenu', function(e) {
                e.originalEvent.preventDefault();
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŸ¥è¯¢è®°å½•å—ï¼Ÿ')) {
                    removeCircle(record.id);
                }
            });
            
            circle.on('click', function(e) {
                if (!isInRadiusMode) {
                    const mallsList = mallsInRange.length > 0 ? 
                        mallsInRange.map(m => `â€¢ ${m.name} (${m.district})`).join('<br>') : 
                        'æ— å•†åœº';
                    
                    const popupContent = `
                        <div style="max-width: 250px;">
                            <b>æŸ¥è¯¢è®°å½• #${record.id}</b><br>
                            <b>åŠå¾„ï¼š</b>${radiusValue} ${unit === 'kilometers' ? 'å…¬é‡Œ' : 'ç±³'}<br>
                            <b>ä¸­å¿ƒï¼š</b>${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}<br>
                            <b>åŒ…å«å•†åœºï¼š</b>${mallsInRange.length} ä¸ª<br>
                            <div style="max-height: 150px; overflow-y: auto; margin-top: 8px; font-size: 12px;">
                                ${mallsList}
                            </div>
                        </div>
                    `;
                    
                    L.popup()
                        .setLatLng(e.latlng)
                        .setContent(popupContent)
                        .openOn(map);
                }
            });
            
            updateRecordsList();
            map.fitBounds(circle.getBounds());
        }
        
        function removeCircle(id) {
            const index = radiusCircles.findIndex(record => record.id === id);
            if (index !== -1) {
                map.removeLayer(radiusCircles[index].circle);
                radiusCircles.splice(index, 1);
                updateRecordsList();
            }
        }
        
        function clearAllCircles() {
            radiusCircles.forEach(record => {
                map.removeLayer(record.circle);
            });
            radiusCircles = [];
            updateRecordsList();
        }
        
        function updateRecordsList() {
            const totalMalls = radiusCircles.reduce((sum, record) => sum + record.mallsCount, 0);
            const recordsStats = document.getElementById('records-stats');
            const totalRecordsSpan = document.getElementById('total-records');
            const totalMallsSpan = document.getElementById('total-malls');
            
            if (radiusCircles.length === 0) {
                noRecords.style.display = 'block';
                clearAllBtn.style.display = 'none';
                recordsStats.style.display = 'none';
                return;
            }
            
            noRecords.style.display = 'none';
            clearAllBtn.style.display = 'block';
            recordsStats.style.display = 'block';
            totalRecordsSpan.textContent = radiusCircles.length;
            totalMallsSpan.textContent = totalMalls;
            
            recordsList.innerHTML = '';
            
            radiusCircles.forEach((record, index) => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'record-item';
                recordDiv.style.borderLeftColor = record.color;
                
                const mallsList = record.malls.length > 0 ? 
                    record.malls.slice(0, 3).map(m => `â€¢ ${m.name}`).join('<br>') + 
                    (record.malls.length > 3 ? `<br>... è¿˜æœ‰ ${record.malls.length - 3} ä¸ª` : '') 
                    : 'æ— å•†åœº';
                
                recordDiv.innerHTML = `
                    <div class="record-header">
                        <span class="record-title" style="color: ${record.color};">ğŸ“ è®°å½• #${record.id}</span>
                        <button class="record-delete" onclick="removeCircle(${record.id})">åˆ é™¤</button>
                    </div>
                    <div class="record-info">
                        <strong>åŠå¾„:</strong> ${record.radius} ${record.unit === 'kilometers' ? 'å…¬é‡Œ' : 'ç±³'}<br>
                        <strong>å•†åœºæ•°é‡:</strong> ${record.mallsCount} ä¸ª<br>
                        <strong>åˆ›å»ºæ—¶é—´:</strong> ${record.timestamp.toLocaleTimeString()}<br>
                        <details style="margin-top: 6px;">
                            <summary style="cursor: pointer; color: var(--secondary-color); font-weight: 600;">æŸ¥çœ‹åŒ…å«çš„å•†åœº</summary>
                            <div style="margin-top: 4px; font-size: 11px; line-height: 1.4;">
                                ${mallsList}
                            </div>
                        </details>
                    </div>
                `;
                recordsList.appendChild(recordDiv);
            });
        }
        
        map.on('click', function(e) {
            if (!isInRadiusMode) return;
            let radius = parseFloat(radiusInput.value);
            if (isNaN(radius) || radius <= 0) {
                alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„æ­£æ•°ä½œä¸ºåŠå¾„ï¼');
            } else {
                createRadiusCircle(e.latlng, radius, radiusUnit.value);
            }
            exitRadiusMode();
        });
        
        const currentTab = document.getElementById('current-tab');
        const historyTab = document.getElementById('history-tab');
        let activeTab = 'current';
        
        currentTab.addEventListener('click', function() {
            if (activeTab !== 'current') {
                currentTab.classList.add('active');
                historyTab.classList.remove('active');
                activeTab = 'current';
                updateRecordsList();
            }
        });
        
        historyTab.addEventListener('click', function() {
            if (activeTab !== 'history') {
                historyTab.classList.add('active');
                currentTab.classList.remove('active');
                activeTab = 'history';
                updateRecordsList();
            }
        });
        
        clearAllBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æŸ¥è¯¢è®°å½•å—ï¼Ÿ')) {
                clearAllCircles();
            }
        });
        
        window.removeCircle = removeCircle;

        const toggleControlBtn = document.getElementById('toggle-control');
        const radiusControl = document.getElementById('radius-control');

        const showControlBtn = document.createElement('button');
        showControlBtn.id = 'show-control-btn';
        showControlBtn.innerHTML = 'ğŸ—ºï¸ æ˜¾ç¤ºæŸ¥è¯¢å·¥å…·';
        showControlBtn.style.position = 'absolute';
        showControlBtn.style.top = '10px';
        showControlBtn.style.right = '10px';
        showControlBtn.style.zIndex = '1001';
        showControlBtn.style.display = 'none';
        showControlBtn.style.padding = '10px 15px';
        showControlBtn.style.backgroundColor = 'var(--primary-color)';
        showControlBtn.style.color = 'white';
        showControlBtn.style.border = 'none';
        showControlBtn.style.borderRadius = 'var(--border-radius)';
        showControlBtn.style.cursor = 'pointer';
        showControlBtn.style.fontWeight = '600';
        showControlBtn.style.boxShadow = 'var(--box-shadow)';
        showControlBtn.title = 'ç‚¹å‡»ä»¥æ¢å¤æ˜¾ç¤ºèŒƒå›´æŸ¥è¯¢å·¥å…·é¢æ¿';
        map.getContainer().parentElement.appendChild(showControlBtn);

        toggleControlBtn.addEventListener('click', function() {
            radiusControl.style.display = 'none';
            showControlBtn.style.display = 'block';
        });

        showControlBtn.addEventListener('click', function() {
            radiusControl.style.display = 'flex';
            showControlBtn.style.display = 'none';
        });

        function makeElementDraggable(element, dragHandle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            dragHandle.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
                element.style.right = "auto";
                element.style.bottom = "auto";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }
        
        const controlHeader = document.querySelector('.control-header');
        if (controlHeader) {
            makeElementDraggable(radiusControl, controlHeader);
        } else {
            makeElementDraggable(radiusControl, radiusControl);
        }
        
        setTimeout(() => {
            const legendControl = document.querySelector('.leaflet-control.leaflet-control-legend');
            const infoControl = document.querySelector('.leaflet-control.leaflet-control-info');
            
            if (legendControl) {
                const legendDiv = legendControl.querySelector('.info');
                if (legendDiv) makeElementDraggable(legendControl);
            }
            
            if (infoControl) {
                const infoDiv = infoControl.querySelector('.info');
                if (infoDiv) makeElementDraggable(infoControl);
            }
        }, 100);
    </script>
</body>
</html>